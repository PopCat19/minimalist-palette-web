<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Scrollable Square Color Palette</title>
        <!-- Include html2canvas library -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
            integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <style>
            :root {
                /* --- Base Layout & Sizing --- */
                /* --cell-size: clamp(2.5em, 5vw, 4em); */ /* REPLACED with fixed size */
                --cell-size: 48px; /* Fixed cell dimension */
                --cell-spacing: 8px;                  /* Space between cells */
                --cell-internal-padding: 0.3em;       /* Padding inside cell content */
                --container-padding: var(--cell-spacing); /* Padding around the table */
                --viewport-width: 100vw;
                --viewport-height: 100vh;

                /* --- Typography --- */
                --base-font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
                --monospace-font-family: "SF Mono", Monaco, Consolas, "Ubuntu Mono", monospace;
                --label-font-size: clamp(0.6em, 1.5vw, 0.8em); /* Responsive cell label font size */
                --cell-content-font-size: smaller;    /* Relative size adjustment for hex code in cell */
                --config-button-font-size: 13px;
                --modal-title-font-size: 16px;
                --modal-label-font-size: 14px;
                --input-font-size: 13px;
                --button-font-size: 14px;
                --copied-feedback-font-size: 10px;

                /* --- Colors --- */
                /* Refined Theme */
                --bg-color: #0f0f0f;
                --surface-color-1: #1a1a1a; /* Container, Modal */
                --surface-color-2: #2a2a2a; /* Cells, Inputs */
                --accent-color: #4a90e2;
                --button-color: #3f3f3f;
                --button-text-color: #e0e0e0;
                --button-hover-color: #555555;
                --text-color: #f0f0f0;
                --text-color-muted: #aaaaaa;
                --text-color-dark-bg: #000000; /* Text on light backgrounds */
                --text-color-light-bg: #FFFFFF; /* Text on dark backgrounds */
                --border-color: #404040;
                --modal-overlay-color: rgba(0, 0, 0, 0.75); /* For copied feedback */
                --placeholder-border-color: var(--border-color); /* Dashed border for empty interpolated cells */
                --placeholder-text-color: var(--text-color-muted);

                /* --- Borders & Radii --- */
                --border-radius: 16px;       /* General border radius */
                --border-radius-small: 8px;  /* Smaller radius for inputs/buttons */
                --border-radius-input: 4px;  /* Even smaller for number inputs */
                --border-width: 1px;
                /* --cell-hover-border-radius: 50%; */ /* REMOVED - Replaced with outline */

                /* --- Transitions & Animations --- */
                --transition-duration: 0.2s;
                --transition-timing: ease;
                --copied-fade-duration: 1s;

                /* --- Components --- */
                /* Modal */
                --modal-padding: 25px;
                --modal-max-width: 550px;
                --modal-max-height: 80vh;
                --modal-gap: 20px; /* Gap between sections */
                --modal-section-padding-bottom: 15px;
                --modal-title-margin-bottom: 15px;
                --modal-close-button-font-size: 24px;
                /* Config Button */
                --config-button-padding: 8px 15px;
                /* Controls (inside modal) */
                --control-group-gap: 10px;
                --slider-width: 150px;
                --slider-height: 5px;
                --number-input-width: 50px;
                --number-input-padding: 4px 6px;
                --number-input-font-size: 12px; /* Smaller font for number inputs */
                /* Palette Input */
                --palette-input-min-height: 200px;
                --palette-input-padding: 10px;
                --palette-input-margin-bottom: 15px;
                /* Update Button */
                --update-button-padding: 9px 18px;
                 /* Zoom Controls */
                 --zoom-label-margin-right: 5px;
                 --zoom-label-font-size: 13px;
                 --zoom-number-input-width: 50px; /* Consistent width */


                /* --- Shadows & Z-Index --- */
                --config-button-shadow: 0 2px 5px rgba(0,0,0,0.2);
                --z-index-modal: 1050;
                --z-index-config-button: 1100;
                --z-index-copied-feedback: 5;

                /* --- Responsive Overrides (kept separate for clarity) --- */
                --responsive-cell-spacing: 2px;
                --responsive-border-radius: 16px; /* Medium screens */
                --responsive-border-radius-small: 12px; /* Small screens */
                --responsive-modal-padding: 20px;
                --responsive-modal-gap: 15px;
                --responsive-modal-title-font-size: 15px;
                --responsive-modal-title-margin-bottom: 12px;
                --responsive-slider-width: 120px;
                --responsive-number-input-width: 45px;
                --responsive-number-input-font-size: 11px;
                --responsive-palette-input-min-height: 180px;
                --responsive-palette-input-font-size: 12px;
                /* Small Screen Specifics */
                --small-config-button-padding: 6px 12px;
                --small-config-button-font-size: 12px;
                --small-modal-padding: 15px;
                --small-modal-gap: 12px;
                --small-control-group-gap: 8px;
                --small-button-padding: 10px 12px;
                --small-slider-width-calc: calc(100% - 70px);
                --small-number-input-width: 50px;
                --small-palette-input-min-height: 150px;
            }

            body {
                background-color: var(--bg-color);
                color: var(--text-color);
                font-family: var(--base-font-family);
                margin: 0;
                padding: 0;
                overflow: hidden;
                min-height: var(--viewport-height);
                width: var(--viewport-width);
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            /* --- Canvas Viewport (Pannable Area) --- */
            #canvas-viewport {
                width: 100%; /* Use 100% instead of viewport unit to fill parent */
                height: var(--viewport-height);
                overflow: hidden;
                position: relative;
                cursor: grab;
                background-color: var(--bg-color);
            }
            #canvas-viewport.grabbing {
                cursor: grabbing;
            }

            /* --- Palette Container (Moved by JS) --- */
            #palette-container {
                position: absolute;
                top: 50px; /* Initial offset - Keep hardcoded or move to JS if dynamic */
                left: 50px; /* Initial offset - Keep hardcoded or move to JS if dynamic */
                background-color: var(--surface-color-1);
                border-radius: var(--border-radius);
                padding: var(--container-padding);
                border: var(--border-width) solid var(--border-color);
            }

            table {
                border-collapse: separate;
                border-spacing: var(--cell-spacing);
                width: auto;
                table-layout: fixed;
                background-color: var(--surface-color-1);
            }

            td {
                width: var(--cell-size);
                height: var(--cell-size);
                padding: 0;
                text-align: center;
                vertical-align: middle;
                border-radius: var(--border-radius);
                font-size: var(--label-font-size);
                font-weight: 500;
                position: relative;
                box-sizing: border-box;
                background-color: transparent;
                color: var(--text-color-muted);
                transition: border-radius var(--transition-duration) var(--transition-timing);
            }

            /* NEW: Inner cell content div */
            .cell-content {
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: var(--cell-internal-padding);
                background-color: var(--surface-color-2);
                border-radius: inherit; /* Inherit from TD */
                font-weight: inherit;
                color: inherit;
                word-wrap: break-word;
                box-sizing: border-box;
                transition:
                    background-color var(--transition-duration) var(--transition-timing),
                    border-radius var(--transition-duration) var(--transition-timing);
                font-size: var(--cell-content-font-size);
            }

            td.legend-label .cell-content {
                font-weight: bold;
            }

            td:hover .cell-content {
                 /* Hover styles can be added here */
            }
            td.swatch .cell-content {
                cursor: pointer;
            }
            td.swatch:hover .cell-content {
                 /* border-radius: var(--cell-hover-border-radius); */ /* REMOVED */
                 outline: 4px solid var(--accent-color);
                 outline-offset: 2px; /* Position outline slightly outside */
            }
            td.label.interpolated-label .cell-content {
                 background-color: transparent;
                 border: var(--border-width) dashed var(--placeholder-border-color);
                 color: var(--placeholder-text-color);
                font-style: italic;
            }

            /* Apply copied feedback to inner div */
            .cell-content.copied::after {
                content: "Copied!";
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background-color: var(--modal-overlay-color);
                color: var(--text-color-light-bg); /* Ensure contrast */
                display: flex; justify-content: center; align-items: center;
                font-size: var(--copied-feedback-font-size);
                font-weight: bold; border-radius: inherit;
                animation: fadeOut var(--copied-fade-duration) forwards;
                z-index: var(--z-index-copied-feedback);
            }

            /* --- Config Toggle Button --- */
            #config-toggle-button {
                position: fixed;
                top: 15px; /* Keep positional offsets */
                right: 15px; /* Keep positional offsets */
                z-index: var(--z-index-config-button);
                background-color: var(--surface-color-1);
                color: var(--text-color-muted);
                border: var(--border-width) solid var(--border-color);
                border-radius: var(--border-radius);
                padding: var(--config-button-padding);
                font-size: var(--config-button-font-size);
                font-weight: 500;
                text-align: center;
                cursor: pointer;
                transition: all var(--transition-duration) var(--transition-timing);
                box-shadow: var(--config-button-shadow);
            }
            #config-toggle-button:hover {
                color: var(--text-color);
                background-color: var(--surface-color-2);
                border-color: var(--accent-color);
            }

            /* --- Config Modal --- */
            #config-modal {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0.95);
                opacity: 0;
                visibility: hidden;
                transition: opacity var(--transition-duration) var(--transition-timing), transform var(--transition-duration) var(--transition-timing), visibility 0s linear var(--transition-duration);
                z-index: var(--z-index-modal);
                background-color: var(--surface-color-1);
                border: var(--border-width) solid var(--border-color);
                border-radius: var(--border-radius);
                padding: var(--modal-padding);
                width: 90%; /* Percentage width for responsiveness */
                max-width: var(--modal-max-width);
                max-height: var(--modal-max-height);
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: var(--modal-gap);
            }
            #config-modal.visible {
                transform: translate(-50%, -50%) scale(1);
                    opacity: 1;
                visibility: visible;
                transition: opacity var(--transition-duration) var(--transition-timing), transform var(--transition-duration) var(--transition-timing), visibility 0s linear 0s;
            }

            .modal-close-button {
                position: absolute;
                top: 10px; /* Keep positional offsets */
                right: 10px; /* Keep positional offsets */
                background: none;
                border: none;
                font-size: var(--modal-close-button-font-size);
                line-height: 1;
                color: var(--text-color-muted);
                cursor: pointer;
            }
            .modal-close-button:hover { color: var(--text-color); }

            .config-section {
                padding-bottom: var(--modal-section-padding-bottom);
                border-bottom: var(--border-width) solid var(--border-color);
            }
            .config-section:last-child { border-bottom: none; padding-bottom: 0; }

            .config-section h3 {
                margin: 0 0 var(--modal-title-margin-bottom) 0;
                font-size: var(--modal-title-font-size);
                font-weight: 600;
                color: var(--text-color);
            }

            .control-group {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: var(--control-group-gap);
                padding-bottom: 0;
                border-bottom: none;
            }

            .control-button {
                /* Base styles, specific overrides below */
                cursor: pointer;
                border-radius: var(--border-radius-small);
                border: var(--border-width) solid var(--border-color); /* Default border */
                background-color: var(--button-color);
                color: var(--button-text-color);
                padding: var(--update-button-padding); /* Use a common button padding */
                font-size: var(--button-font-size);
                font-weight: 500;
                transition: all var(--transition-duration) var(--transition-timing);
            }
             .control-button:hover {
                 background-color: var(--button-hover-color);
                 border-color: var(--accent-color); /* Highlight border on hover */
             }
             .control-button:focus-visible {
                 outline: none;
                 border-color: var(--accent-color); /* Highlight border on focus */
             }

            #interpolation-controls,
            #saturation-controls,
            #zoom-controls { /* Apply common layout */
                width: 100%;
                 display: flex;
                 flex-wrap: wrap;
                 align-items: center;
                 gap: var(--control-group-gap);
            }
            #interpolation-controls label,
            #saturation-controls label,
            #zoom-controls label { /* Common label styles */
                cursor: pointer;
                user-select: none;
                margin-right: var(--zoom-label-margin-right);
                font-size: var(--zoom-label-font-size); /* Use consistent label size */
                color: var(--text-color-muted);
            }
            input[type="checkbox"] {
                 cursor: pointer;
                 accent-color: var(--accent-color);
            }
            .slider-group {
                 display: flex;
                 align-items: center;
                 gap: var(--control-group-gap); /* Use consistent gap */
            }
            input[type="range"] {
                 width: var(--slider-width);
                 height: var(--slider-height);
                cursor: pointer;
                 accent-color: var(--accent-color);
                 vertical-align: middle;
            }
            input[type="number"] {
                 width: var(--number-input-width);
                 background-color: var(--surface-color-2);
                 color: var(--text-color);
                 border: var(--border-width) solid var(--border-color);
                 border-radius: var(--border-radius-input);
                 padding: var(--number-input-padding);
                 font-size: var(--number-input-font-size);
                 text-align: center;
                 -moz-appearance: textfield;
            }
            input[type="number"]::-webkit-outer-spin-button,
            input[type="number"]::-webkit-inner-spin-button {
                 -webkit-appearance: none;
                 margin: 0;
            }
             input[type="number"]:focus-visible {
                 outline: none;
                 border-color: var(--accent-color);
             }

            #palette-editor-section {
                display: none;
            }
            #config-modal.editor-visible #palette-editor-section {
                display: block;
            }
            /* Label specific styling */
             #palette-editor-section > label[for="palette-input"] {
                 display: block;
                 margin-bottom: 10px; /* Specific margin */
                 font-weight: 500;
                 font-size: var(--modal-label-font-size);
             }

            #palette-input {
                width: 100%;
                min-height: var(--palette-input-min-height);
                background-color: var(--surface-color-2);
                color: var(--text-color);
                border: var(--border-width) solid var(--border-color);
                border-radius: var(--border-radius-small);
                padding: var(--palette-input-padding);
                font-family: var(--monospace-font-family);
                font-size: var(--input-font-size);
                box-sizing: border-box;
                resize: vertical;
                margin-bottom: var(--palette-input-margin-bottom);
                white-space: pre; overflow-wrap: normal; overflow-x: auto;
            }
            #palette-input:focus-visible { outline: none; border-color: var(--accent-color); }

            #update-button { /* Specific styles for the main update button */
                background-color: var(--accent-color);
                color: var(--text-color-light-bg); /* Ensure contrast */
                border: none;
                padding: var(--update-button-padding);
                border-radius: var(--border-radius-small);
                cursor: pointer;
                font-size: var(--button-font-size);
                font-weight: 500;
                transition: all var(--transition-duration) var(--transition-timing);
                display: block; width: fit-content; margin: 0 auto;
            }
            #update-button:hover { background-color: #3a80d2; } /* Keep specific hover */
            #update-button:focus-visible { outline: none; border-color: var(--text-color-light-bg); }


             #zoom-slider {
                  width: var(--slider-width); /* Reuse standard slider width */
             }
             #zoom-number {
                  width: var(--zoom-number-input-width); /* Specific width if needed */
             }

            /* --- Responsive Adjustments --- */
            @media (max-width: 768px) {
                :root {
                    --cell-spacing: var(--responsive-cell-spacing);
                    --border-radius: var(--responsive-border-radius);
                }
                #config-modal {
                    width: 95%; /* Slightly wider on medium screens */
                    padding: var(--responsive-modal-padding);
                    gap: var(--responsive-modal-gap);
                }
                .config-section h3 {
                    font-size: var(--responsive-modal-title-font-size);
                    margin-bottom: var(--responsive-modal-title-margin-bottom);
                }
                 input[type="range"] { width: var(--responsive-slider-width); }
                 #zoom-slider { width: var(--responsive-slider-width); } /* Apply responsive width */
                 input[type="number"] {
                    width: var(--responsive-number-input-width);
                    font-size: var(--responsive-number-input-font-size);
                 }
                 #zoom-number {
                     width: var(--responsive-number-input-width); /* Apply responsive width */
                     font-size: var(--responsive-number-input-font-size); /* Apply responsive font size */
                }
                #palette-input {
                    min-height: var(--responsive-palette-input-min-height);
                    font-size: var(--responsive-palette-input-font-size);
                }
            }

            @media (max-width: 480px) {
                :root {
                    /* Keep cell-spacing from medium */
                    --border-radius: var(--responsive-border-radius-small); /* Use smaller radius */
                }
                #config-toggle-button {
                    padding: var(--small-config-button-padding);
                    font-size: var(--small-config-button-font-size);
                }
                #config-modal {
                     /* width: 95% is fine */
                     padding: var(--small-modal-padding);
                     gap: var(--small-modal-gap);
                }
                 .control-group {
                     flex-direction: column;
                     align-items: stretch; /* Make items fill width */
                     gap: var(--small-control-group-gap);
                 }
                 .control-button { /* Full width button */
                    width: 100%;
                    text-align: center;
                    padding: var(--small-button-padding);
                }
                #interpolation-controls,
                 #saturation-controls,
                 #zoom-controls { /* Stack controls vertically */
                    flex-direction: column;
                     align-items: flex-start; /* Align labels left */
                     gap: var(--small-control-group-gap);
                 }
                 .slider-group {
                    width: 100%;
                    justify-content: space-between; /* Space out slider and number */
                 }
                 input[type="range"] { width: var(--small-slider-width-calc); }
                 #zoom-slider { width: var(--small-slider-width-calc); }
                 input[type="number"] { width: var(--small-number-input-width); }
                 #zoom-number { width: var(--small-number-input-width); }
                #palette-input { min-height: var(--small-palette-input-min-height); }
                #update-button { width: 100%; } /* Full width modal button */
            }
        </style>
    </head>
    <body>
        <!-- Config Toggle Button -->
        <button id="config-toggle-button" aria-label="Open Configuration">Config</button>

        <!-- Pannable Viewport -->
        <div id="canvas-viewport">
            <!-- Palette Container (moved by JS) -->
            <div id="palette-container">
                <table id="palette-table">
                    <tbody>
                        <!-- Table rows will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Configuration Modal -->
        <div id="config-modal">
            <button class="modal-close-button" aria-label="Close Configuration">&times;</button>

            <div class="config-section">
                <h3>Palette Actions</h3>
                <div class="control-group">
                <button id="edit-palette-button" class="control-button">
                    Edit Palette Data
                </button>
                <button id="export-png-button" class="control-button">
                    Export as PNG
                </button>
            </div>
            </div>

             <div class="config-section" id="palette-editor-section">
                 <!-- <h3>Edit Palette</h3> -->
                 <label
                    for="palette-input"
                    style="display: block; margin-bottom: 10px; font-weight: 500; font-size: 14px;"
                >
                    Palette Data (Space-Delimited rows, #Hex for colors):
                </label>
                <textarea
                    id="palette-input"
                    spellcheck="false"
                    placeholder="Example Row:&#10;Label1 #ff0000 #00ff00 Label2 #0000ff ..."
                ></textarea>
                <button id="update-button">Update Palette from Text</button>
            </div>

            <div class="config-section">
                <h3>Adjustments</h3>
                 <div id="interpolation-controls" class="control-group">
                     <label for="interpolation-toggle">
                         Distribute Shades (Vertical):
                     </label>
                <input type="checkbox" id="interpolation-toggle" />
                     <div id="interpolation-steps-group" class="slider-group">
                    <label for="interpolation-steps-slider">Steps:</label>
                    <input
                        type="range"
                        id="interpolation-steps-slider"
                             min="1" max="10" value="1" step="1"
                    />
                    <input
                        type="number"
                        id="interpolation-steps-number"
                             min="1" max="10" value="1"
                    />
                </div>
            </div>
                  <div id="saturation-controls" class="control-group">
                <label for="saturation-offset-slider">Saturation Offset:</label>
                     <div id="saturation-offset-group" class="slider-group">
                    <input
                        type="range"
                        id="saturation-offset-slider"
                             min="-100" max="100" value="0" step="1"
                    />
                    <input
                        type="number"
                        id="saturation-offset-number"
                             min="-100" max="100" value="0"
                    />
                    <span>%</span>
                </div>
            </div>
        </div>
             <!-- NEW: Zoom Section -->
             <div class="config-section">
                 <h3>View</h3>
                 <div id="zoom-controls" class="control-group">
                     <label for="zoom-slider">Zoom:</label>
                     <input type="range" id="zoom-slider" min="10" max="500" value="100" step="1">
                     <input type="number" id="zoom-number" min="10" max="500" value="100">
                     <span>%</span>
        </div>
            </div>
        </div>

        <script>
            // --- Initial Data (Minimal Format: Strings for labels, #Hex for colors) ---
            let sourceGridData = [
                // Freeze to prevent accidental modification
                [
                    "100x",
                    "#FFFFFF",
                    "Red",
                    "Vermilion",
                    "Orange",
                    "Amber",
                    "Yellow",
                    "Lime",
                    "Chartreuse",
                    "Ddahai",
                    "Green",
                    "Erin",
                    "Spring",
                    "Gashtanta",
                    "Cyan",
                    "Capri",
                    "Azure",
                    "Cerulean",
                    "Blue",
                    "Volta",
                    "Violet",
                    "Llew",
                    "Magenta",
                    "Cerise",
                    "Rose",
                    "Crimson",
                    "100x",
                ],
                [
                    "96x",
                    "#F4F4F4",
                    "#FFEBEB",
                    "#FFF0EB",
                    "#FFF5EB",
                    "#FFFAEB",
                    "#FFFFEB",
                    "#FAFFEB",
                    "#F5FFEB",
                    "#F0FFEB",
                    "#EBFFEB",
                    "#EBFFF0",
                    "#EBFFF5",
                    "#EBFFFA",
                    "#EBFFFF",
                    "#EBFAFF",
                    "#EBF5FF",
                    "#EBF0FF",
                    "#EBEBFF",
                    "#F0EBFF",
                    "#F5EBFF",
                    "#FAEBFF",
                    "#FFEBFF",
                    "#FFEBFA",
                    "#FFEBF5",
                    "#FFEBF0",
                    "96x",
                ],
                [
                    "88x",
                    "#E0E0E0",
                    "#FFC2C2",
                    "#FFD1C2",
                    "#FFE0C2",
                    "#FFF0C2",
                    "#FFFFC2",
                    "#F0FFC2",
                    "#E0FFC2",
                    "#D1FFC2",
                    "#C2FFC2",
                    "#C2FFD1",
                    "#C2FFE0",
                    "#C2FFF0",
                    "#C2FFFF",
                    "#C2F0FF",
                    "#C2E0FF",
                    "#C2D1FF",
                    "#C2C2FF",
                    "#D1C2FF",
                    "#E0C2FF",
                    "#F0C2FF",
                    "#FFC2FF",
                    "#FFC2F0",
                    "#FFC2E0",
                    "#FFC2D1",
                    "88x",
                ],
                [
                    "80x",
                    "#CCCCCC",
                    "#FF9999",
                    "#FFB399",
                    "#FFCC99",
                    "#FFE599",
                    "#FFFF99",
                    "#E5FF99",
                    "#CCFF99",
                    "#B2FF99",
                    "#99FF99",
                    "#99FFB3",
                    "#99FFCC",
                    "#99FFE5",
                    "#99FFFF",
                    "#99E5FF",
                    "#99CCFF",
                    "#99B2FF",
                    "#9999FF",
                    "#B399FF",
                    "#CC99FF",
                    "#E599FF",
                    "#FF99FF",
                    "#FF99E5",
                    "#FF99CC",
                    "#FF99B2",
                    "80x",
                ],
                [
                    "64x",
                    "#A3A3A3",
                    "#FF4747",
                    "#FF7547",
                    "#FFA347",
                    "#FFD147",
                    "#FFFF47",
                    "#D1FF47",
                    "#A3FF47",
                    "#75FF47",
                    "#47FF47",
                    "#47FF75",
                    "#47FFA3",
                    "#47FFD1",
                    "#47FFFF",
                    "#47D1FF",
                    "#47A3FF",
                    "#4775FF",
                    "#4747FF",
                    "#7547FF",
                    "#A347FF",
                    "#D147FF",
                    "#FF47FF",
                    "#FF47D1",
                    "#FF47A3",
                    "#FF4775",
                    "64x",
                ],
                [
                    "48x",
                    "#7A7A7A",
                    "#B54040",
                    "#B55D40",
                    "#B57A40",
                    "#B59840",
                    "#B5B540",
                    "#98B540",
                    "#7AB540",
                    "#5DB540",
                    "#40B540",
                    "#40B55D",
                    "#40B57A",
                    "#40B598",
                    "#40B5B5",
                    "#4098B5",
                    "#407AB5",
                    "#405DB5",
                    "#4040B5",
                    "#5D40B5",
                    "#7A40B5",
                    "#9840B5",
                    "#B540B5",
                    "#B54098",
                    "#B5407A",
                    "#B5405D",
                    "48x",
                ],
                [
                    "32x",
                    "#525252",
                    "#792A2A",
                    "#793E2A",
                    "#79522A",
                    "#79652A",
                    "#79792A",
                    "#65792A",
                    "#52792A",
                    "#3E792A",
                    "#2A792A",
                    "#2A793E",
                    "#2A7952",
                    "#2A7965",
                    "#2A7979",
                    "#2A6579",
                    "#2A5279",
                    "#2A3E79",
                    "#2A2A79",
                    "#3E2A79",
                    "#522A79",
                    "#652A79",
                    "#792A79",
                    "#792A65",
                    "#792A52",
                    "#792A3E",
                    "32x",
                ],
                [
                    "24x",
                    "#3D3D3D",
                    "#5B2020",
                    "#5B2F20",
                    "#5B3D20",
                    "#5B4C20",
                    "#5B5B20",
                    "#4C5B20",
                    "#3D5B20",
                    "#2F5B20",
                    "#205B20",
                    "#205B2F",
                    "#205B3D",
                    "#205B4C",
                    "#205B5B",
                    "#204C5B",
                    "#203D5B",
                    "#202F5B",
                    "#20205B",
                    "#2F205B",
                    "#3D205B",
                    "#4C205B",
                    "#5B205B",
                    "#5B204C",
                    "#5B203D",
                    "#5B202F",
                    "24x",
                ],
                [
                    "16x",
                    "#292929",
                    "#3C1515",
                    "#3C1F15",
                    "#3C2915",
                    "#3C3315",
                    "#3C3C15",
                    "#333C15",
                    "#293C15",
                    "#1F3C15",
                    "#153C15",
                    "#153C1F",
                    "#153C29",
                    "#153C33",
                    "#153C3C",
                    "#15333C",
                    "#15293C",
                    "#151F3C",
                    "#15153C",
                    "#1F153C",
                    "#29153C",
                    "#33153C",
                    "#3C153C",
                    "#3C1533",
                    "#3C1529",
                    "#3C151F",
                    "16x",
                ],
                [
                    "12x",
                    "#1F1F1F",
                    "#2D1010",
                    "#2D1710",
                    "#2D1F10",
                    "#2D2610",
                    "#2D2D10",
                    "#262D10",
                    "#1F2D10",
                    "#172D10",
                    "#102D10",
                    "#102D17",
                    "#102D1F",
                    "#102D26",
                    "#102D2D",
                    "#10262D",
                    "#101F2D",
                    "#10172D",
                    "#10102D",
                    "#17102D",
                    "#1F102D",
                    "#26102D",
                    "#2D102D",
                    "#2D1026",
                    "#2D101F",
                    "#2D1017",
                    "12x",
                ],
                [
                    "8x",
                    "#141414",
                    "#1E0B0B",
                    "#1E100B",
                    "#1E140B",
                    "#1E190B",
                    "#1E1E0B",
                    "#191E0B",
                    "#141E0B",
                    "#101E0B",
                    "#0B1E0B",
                    "#0B1E10",
                    "#0B1E14",
                    "#0B1E19",
                    "#0B1E1E",
                    "#0B191E",
                    "#0B141E",
                    "#0B101E",
                    "#0B0B1E",
                    "#100B1E",
                    "#140B1E",
                    "#190B1E",
                    "#1E0B1E",
                    "#1E0B19",
                    "#1E0B14",
                    "#1E0B10",
                    "8x",
                ],
                [
                    "0x",
                    "#000000",
                    "0",
                    "15",
                    "30",
                    "45",
                    "60",
                    "75",
                    "90",
                    "105",
                    "120",
                    "135",
                    "150",
                    "165",
                    "180",
                    "195",
                    "210",
                    "225",
                    "240",
                    "255",
                    "270",
                    "285",
                    "300",
                    "315",
                    "330",
                    "345",
                    "0x",
                ],
            ];

            // --- State Variables ---
            let currentGridData = [...sourceGridData.map((row) => [...row])];
            let isInterpolationEnabled = false;
            let interpolationSteps = 1;
            let saturationOffset = 0;
            // --- NEW: Panning State ---
            let isPanning = false;
            let startX, startY, currentX, currentY;
            let paletteOffsetX = 50; // Initial offset matches CSS
            let paletteOffsetY = 50;
            // --- NEW: Zoom State ---
            let scale = 1;
            const minScale = 0.1;
            const maxScale = 5;
            const scaleStep = 0.1;
            const zoomDebounceDelay = 10; // Optional: debounce zoom updates slightly
            let zoomTimeout;
            // --- NEW: Track forced cell size ---
            // let lastForcedCellSizePx = null; // REMOVED - No longer needed

            // --- DOM Elements ---
            // Palette display elements
            const canvasViewport = document.getElementById('canvas-viewport');
            const paletteContainer = document.getElementById('palette-container');
            const paletteTable = document.getElementById('palette-table');
            const tableBody = paletteTable.getElementsByTagName('tbody')[0];

            // Config Modal elements
            const configToggleButton = document.getElementById('config-toggle-button');
            const configModal = document.getElementById('config-modal');
            const closeModalButton = configModal.querySelector('.modal-close-button'); // Find close button inside modal
            const editPaletteButton = document.getElementById('edit-palette-button');
            const paletteEditorSection = document.getElementById('palette-editor-section');
            const paletteInput = document.getElementById('palette-input');
            const updateButton = document.getElementById('update-button');
            const exportPngButton = document.getElementById('export-png-button');

            // Adjustment controls (now inside modal)
            const interpolationToggle = document.getElementById('interpolation-toggle');
            const interpolationStepsGroup = document.getElementById('interpolation-steps-group');
            const stepsSlider = document.getElementById('interpolation-steps-slider');
            const stepsNumber = document.getElementById('interpolation-steps-number');
            const saturationOffsetSlider = document.getElementById('saturation-offset-slider');
            const saturationOffsetNumber = document.getElementById('saturation-offset-number');

            // --- NEW: Zoom Controls Elements ---
            const zoomSlider = document.getElementById('zoom-slider');
            const zoomNumber = document.getElementById('zoom-number');

            // --- Helper Functions ---
            function isValidHex(str) {
                return (
                    typeof str === "string" &&
                    str.startsWith("#") &&
                    (str.length === 4 || str.length === 7) &&
                    /^#[0-9A-Fa-f]+$/.test(str)
                );
            }
            function hexToRgb(hex) {
                let shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
                hex = hex.replace(
                    shorthandRegex,
                    (m, r, g, b) => r + r + g + g + b + b,
                );
                let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(
                    hex,
                );
                return result
                    ? {
                          r: parseInt(result[1], 16),
                          g: parseInt(result[2], 16),
                          b: parseInt(result[3], 16),
                      }
                    : null;
            }
            function componentToHex(c) {
                let hex = c.toString(16);
                return hex.length == 1 ? "0" + hex : hex;
            }
            function rgbToHex(r, g, b) {
                return (
                    "#" +
                    componentToHex(r) +
                    componentToHex(g) +
                    componentToHex(b)
                );
            }
            function interpolateHexColor(hex1, hex2, steps) {
                const rgb1 = hexToRgb(hex1);
                const rgb2 = hexToRgb(hex2);
                if (!rgb1 || !rgb2) return []; // Invalid input

                const interpolatedColors = [];
                const totalIntervals = steps + 1;

                for (let i = 1; i <= steps; i++) {
                    const r = Math.round(
                        rgb1.r + (rgb2.r - rgb1.r) * (i / totalIntervals),
                    );
                    const g = Math.round(
                        rgb1.g + (rgb2.g - rgb1.g) * (i / totalIntervals),
                    );
                    const b = Math.round(
                        rgb1.b + (rgb2.b - rgb1.b) * (i / totalIntervals),
                    );
                    interpolatedColors.push(rgbToHex(r, g, b));
                }
                return interpolatedColors;
            }

            // --- NEW: HSL Conversion and Adjustment ---
            function rgbToHsl(r, g, b) {
                r /= 255;
                g /= 255;
                b /= 255;
                const max = Math.max(r, g, b),
                    min = Math.min(r, g, b);
                let h,
                    s,
                    l = (max + min) / 2;

                if (max == min) {
                    h = s = 0; // achromatic
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r:
                            h = (g - b) / d + (g < b ? 6 : 0);
                            break;
                        case g:
                            h = (b - r) / d + 2;
                            break;
                        case b:
                            h = (r - g) / d + 4;
                            break;
                    }
                    h /= 6;
                }
                return { h, s, l }; // h, s, l are in [0, 1] range
            }

            function hslToRgb(h, s, l) {
                let r, g, b;

                if (s == 0) {
                    r = g = b = l; // achromatic
                } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1 / 6) return p + (q - p) * 6 * t;
                        if (t < 1 / 2) return q;
                        if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                        return p;
                    };
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1 / 3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1 / 3);
                }
                return {
                    r: Math.round(r * 255),
                    g: Math.round(g * 255),
                    b: Math.round(b * 255),
                };
            }

            function adjustSaturation(hexColor, offsetPercent) {
                const rgb = hexToRgb(hexColor);
                if (!rgb) return hexColor; // Return original if invalid

                const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);

                // --- NEW: Check if the color is neutral (very low saturation) ---
                const saturationThreshold = 0.01; // Adjust as needed
                if (hsl.s < saturationThreshold) {
                    return hexColor; // Return original color if it's neutral
                }
                // --- END NEW ---

                // Adjust saturation: offset is -100 to 100, convert to -1.0 to 1.0
                const offset = offsetPercent / 100;
                hsl.s = Math.max(0, Math.min(1, hsl.s + offset)); // Clamp between 0 and 1

                const newRgb = hslToRgb(hsl.h, hsl.s, hsl.l);
                return rgbToHex(newRgb.r, newRgb.g, newRgb.b);
            }
            // --- END NEW HSL ---

            // --- Core Logic ---

            // Generate a new grid with vertically interpolated colors (inserts rows)
            function generateInterpolatedPalette(originalData, steps) {
                if (steps <= 0) return originalData.map((row) => [...row]); // Return a copy

                const newGridData = [];
                if (!originalData || originalData.length === 0)
                    return newGridData;

                const numCols = originalData[0].length;

                // Add the top header row (Row 0)
                newGridData.push([...originalData[0]]);

                // Iterate through original rows, checking pairs for interpolation
                // Skip first (header) and last (footer) rows for starting interpolation
                for (let i = 1; i < originalData.length - 2; i++) {
                    const currentRow = originalData[i];
                    const nextRow = originalData[i + 1];

                    // Add the current original row to the new grid
                    newGridData.push([...currentRow]);

                    // Prepare arrays to hold interpolated colors for each step (new row)
                    const interpolatedRowsData = Array.from(
                        { length: steps },
                        () => new Array(numCols).fill(""),
                    );

                    let canInterpolateRowPair = false; // Can we interpolate between row i and i+1?

                    // Iterate through columns (excluding first and last label columns)
                    for (let j = 1; j < numCols - 1; j++) {
                        const cell1 = currentRow[j];
                        const cell2 = nextRow[j];

                        // Check if BOTH cells in the column are valid hex colors
                        if (isValidHex(cell1) && isValidHex(cell2)) {
                            canInterpolateRowPair = true; // Found a column to interpolate
                            const interpolatedColors = interpolateHexColor(
                                cell1,
                                cell2,
                                steps,
                            );

                            // Place interpolated colors into the corresponding step's row data
                            for (let s = 0; s < steps; s++) {
                                interpolatedRowsData[s][j] =
                                    interpolatedColors[s];
                            }
                        } else {
                            // If not interpolating this column, fill placeholder rows with empty strings
                            for (let s = 0; s < steps; s++) {
                                interpolatedRowsData[s][j] = ""; // Keep empty or copy label? Empty is simpler.
                            }
                        }
                    }

                    // If interpolation was possible between these rows, add the new rows
                    if (canInterpolateRowPair) {
                        interpolatedRowsData.forEach((newRowData) => {
                            // Add placeholders for first/last column labels in the new rows
                            newRowData[0] = "-"; // Placeholder for left label
                            newRowData[newRowData.length - 1] = "-"; // Placeholder for right label
                            newGridData.push(newRowData);
                        });
                    }
                }

                // Add the second to last original row (which was skipped in the loop)
                if (originalData.length > 2) {
                    newGridData.push([
                        ...originalData[originalData.length - 2],
                    ]);
                }
                // Add the last original row (bottom labels/colors)
                if (originalData.length > 1) {
                    newGridData.push([
                        ...originalData[originalData.length - 1],
                    ]);
                }

                return newGridData;
            }

            function convertToSimpleFormat(gridData) {
                return gridData.map((row) => row.join(" ")).join("\n");
            }
            function parseSimpleFormat(textData) {
                const lines = textData.trim().split("\n");
                return lines.map((line) => {
                    return line
                        .trim()
                        .split(" ")
                        .filter((cell) => cell !== "");
                });
            }
            function getTextColor(hexBgColor) {
                if (!hexBgColor || typeof hexBgColor !== "string")
                    return "#000000"; // Default to black
                const rgb = hexToRgb(hexBgColor);
                if (!rgb) return "#000000"; // Default to black on error
                // Calculate luminance (per WCAG)
                const lum = (0.2126 * rgb.r + 0.7152 * rgb.g + 0.0722 * rgb.b) / 255;
                // Return pure white or black for maximum contrast
                return lum > 0.5 ? "#000000" : "#FFFFFF";
            }
            async function copyToClipboard(text, element) {
                if (!navigator.clipboard) {
                    try {
                        const textArea = document.createElement("textarea");
                        textArea.value = text;
                        textArea.style.position = "fixed";
                        textArea.style.opacity = "0";
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        document.execCommand("copy");
                        document.body.removeChild(textArea);
                        showCopiedFeedback(element);
                    } catch (err) {
                        console.error("Fallback copy failed: ", err);
                        alert("Failed to copy. Your browser might not support this feature or require specific permissions.");
                    }
                    return;
                }
                try {
                    await navigator.clipboard.writeText(text);
                    showCopiedFeedback(element);
                } catch (err) {
                    console.error("Failed to copy text: ", err);
                    alert("Failed to copy.");
                }
            }
            function showCopiedFeedback(element) {
                element.classList.add("copied");
                setTimeout(() => element.classList.remove("copied"), 1000);
            }

            // Render the palette table from grid data
            function renderPalette(gridData) {
                tableBody.innerHTML = ""; // Clear previous content
                if (!Array.isArray(gridData)) {
                    console.error("Invalid grid data: not an array");
                    return;
                }

                gridData.forEach((rowData, rowIndex) => {
                    if (!Array.isArray(rowData)) {
                        console.warn(`Skipping invalid row ${rowIndex}`);
                        return;
                    }
                    const row = tableBody.insertRow();

                    rowData.forEach((cellData, cellIndex) => {
                        const td = row.insertCell(); // Create the outer TD

                        // --- CREATE INNER DIV --- 
                        const cellContentDiv = document.createElement('div');
                        cellContentDiv.classList.add('cell-content');
                        td.appendChild(cellContentDiv);
                        // --- END INNER DIV --- 

                        const isInterpolatedLabelPlaceholder = cellData === "-";

                        if (isValidHex(cellData)) {
                            // It's a color swatch
                            const originalHexColor = cellData;
                            const adjustedHexColor = adjustSaturation(originalHexColor, saturationOffset);
                            const adjustedHexText = adjustedHexColor.substring(1).toUpperCase();

                            // --- Apply styles and content to INNER DIV ---
                            cellContentDiv.style.backgroundColor = adjustedHexColor;
                            cellContentDiv.textContent = adjustedHexText;
                            cellContentDiv.style.color = getTextColor(adjustedHexColor);
                            td.classList.add("swatch"); // Add swatch class to TD for hover targeting
                            cellContentDiv.dataset.originalHex = originalHexColor.substring(1).toUpperCase();
                            cellContentDiv.dataset.adjustedHex = adjustedHexText;

                            cellContentDiv.addEventListener("click", () => {
                                copyToClipboard(adjustedHexText, cellContentDiv); // Target inner div for copy feedback
                            });
                            // --- END INNER DIV STYLING ---

                        } else if (typeof cellData === "string") {
                            // It's a label or placeholder
                            // --- Apply styles and content to INNER DIV ---
                            cellContentDiv.textContent = cellData;
                            td.classList.add("label"); // Add label class to TD
                            if (isInterpolatedLabelPlaceholder) {
                                td.classList.add("interpolated-label"); // Add placeholder class to TD for CSS targeting
                            } else {
                                cellContentDiv.style.color = getTextColor('#2a2a2a'); // Set contrast vs default inner background
                                // --- NEW: Add class for bolding legends ---
                                if (cellIndex === 0 || cellIndex === rowData.length - 1 || rowIndex === 0 || rowIndex === gridData.length - 1) {
                                    td.classList.add("legend-label");
                                }
                            }
                            // --- END INNER DIV STYLING ---
                        } else {
                            // Invalid data
                            console.warn(
                                `Invalid cell data type at row ${rowIndex}, cell ${cellIndex}:`,
                                typeof cellData,
                                cellData,
                            );
                            // --- Apply styles and content to INNER DIV ---
                            cellContentDiv.textContent = "?";
                            cellContentDiv.style.backgroundColor = "#555";
                            cellContentDiv.style.color = "var(--text-color)";
                            // --- END INNER DIV STYLING ---
                        }
                    });
                });
            }

            // Update the view based on interpolation state
            function updatePaletteView() {
                if (isInterpolationEnabled) {
                    currentGridData = generateInterpolatedPalette(
                        sourceGridData,
                        interpolationSteps,
                    );
                } else {
                    // Reset to a fresh copy of the source data
                    currentGridData = sourceGridData.map((row) => [...row]);
                }
                // Render the potentially interpolated grid.
                // Saturation is applied *during* renderPalette.
                renderPalette(currentGridData);
            }

            // --- NEW: Panning Logic ---
            function startPan(event) {
                isPanning = true;
                startX = event.clientX || event.touches[0].clientX;
                startY = event.clientY || event.touches[0].clientY;
                canvasViewport.classList.add('grabbing');
                // Prevent text selection during drag
                event.preventDefault();
            }

            function panMove(event) {
                if (!isPanning) return;
                event.preventDefault();
                currentX = event.clientX || event.touches[0].clientX;
                currentY = event.clientY || event.touches[0].clientY;

                const dx = currentX - startX;
                const dy = currentY - startY;

                paletteOffsetX += dx;
                paletteOffsetY += dy;

                // Apply transform using the dedicated function
                updateTransform();

                // Update start for next move delta
                startX = currentX;
                startY = currentY;
            }

            function endPan() {
                if (isPanning) {
                     isPanning = false;
                     canvasViewport.classList.remove('grabbing');
                }
            }

            // --- REVISED: Zoom Logic (triggered by controls) ---
            function applyZoom(newScalePercent) {
                const newScale = Math.max(minScale, Math.min(maxScale, newScalePercent / 100));

                // If scale didn't change, do nothing
                if (newScale === scale) return;

                // Get mouse position relative to the viewport
                const rect = canvasViewport.getBoundingClientRect();

                // Use viewport center as the zoom focal point
                const focalX = rect.width / 2;
                const focalY = rect.height / 2;

                // Calculate the point on the palette container under the mouse before zoom
                const pointX = (focalX - paletteOffsetX) / scale;
                const pointY = (focalY - paletteOffsetY) / scale;

                // Update scale
                scale = newScale;

                // Calculate the new offset to keep the point under the mouse stationary
                paletteOffsetX = focalX - pointX * scale;
                paletteOffsetY = focalY - pointY * scale;

                // Apply new transform
                updateTransform();
            }

            // --- NEW: Apply Transform Function ---
            function updateTransform() {
                paletteContainer.style.transform = `translate(${paletteOffsetX}px, ${paletteOffsetY}px) scale(${scale})`;
            }

            // --- Event Listeners ---

            // Panning Listeners
            canvasViewport.addEventListener('mousedown', startPan);
            canvasViewport.addEventListener('mousemove', panMove);
            canvasViewport.addEventListener('mouseup', endPan);
            canvasViewport.addEventListener('mouseleave', endPan); // Stop panning if mouse leaves viewport
            // Touch Events for mobile
            canvasViewport.addEventListener('touchstart', startPan, { passive: false }); // passive: false to allow preventDefault
            canvasViewport.addEventListener('touchmove', panMove, { passive: false });
            canvasViewport.addEventListener('touchend', endPan);
            canvasViewport.addEventListener('touchcancel', endPan);

            // Config Modal Toggle Listeners
            configToggleButton.addEventListener('click', () => {
                configModal.classList.toggle('visible');
                // Hide editor when opening modal initially
                if (configModal.classList.contains('visible')) {
                    configModal.classList.remove('editor-visible');
                }
            });
            closeModalButton.addEventListener('click', () => {
                configModal.classList.remove('visible');
            });
            // Optional: Close modal on background click
            // configModal.addEventListener('click', (event) => {
            //     if (event.target === configModal) { // Click was directly on the modal background
            //         configModal.classList.remove('visible');
            //     }
            // });

            // Show/Hide Palette Editor within Modal
            editPaletteButton.addEventListener('click', () => {
                paletteInput.value = convertToSimpleFormat(sourceGridData); // Load current source data
                configModal.classList.add('editor-visible'); // Show the editor section
            });

            // Update Button (now inside config modal)
            updateButton.addEventListener('click', () => {
                const textData = paletteInput.value;
                try {
                    const newDataParsed = parseSimpleFormat(textData);
                    if (!Array.isArray(newDataParsed) || newDataParsed.length === 0 || !Array.isArray(newDataParsed[0])) {
                        throw new Error("Parsed data is not a valid grid.");
                    }
                    sourceGridData = newDataParsed;
                    isInterpolationEnabled = false; // Reset interpolation
                    interpolationToggle.checked = false;
                    currentGridData = sourceGridData.map(row => [...row]);
                    renderPalette(currentGridData); // Re-render main palette
                    configModal.classList.remove('editor-visible'); // Hide editor section
                    configModal.classList.remove('visible'); // Close modal after update
                    alert('Palette source updated. Shade distribution disabled.');
                } catch (error) {
                    console.error("Error parsing or processing text input:", error);
                    alert(`Failed to update palette:\n${error.message}\n\nPlease check the format.`);
                }
            });

            // Export PNG Event Listener (Target remains paletteTable)
            exportPngButton.addEventListener('click', () => {
                // Disable button temporarily
                exportPngButton.disabled = true;
                exportPngButton.textContent = 'Exporting...';

                 // Ensure the modal is closed or doesn't interfere (optional, usually fine)
                 // configModal.classList.remove('visible');

                // Slight delay to allow UI to settle if needed
                setTimeout(() => {
                    // Determine the background color to use
                    const tableBgColor = getComputedStyle(paletteContainer).backgroundColor;

                    html2canvas(paletteTable, {
                        backgroundColor: tableBgColor, // Use container BG for capture
                        useCORS: true,
                        logging: false,
                        // Position/offset adjustments might be needed if transform interferes
                        // x: paletteContainer.offsetLeft, // Experiment if capture is off
                        // y: paletteContainer.offsetTop,
                    })
                    .then(canvas => {
                        const pngUrl = canvas.toDataURL('image/png');
                        const downloadLink = document.createElement('a');
                            downloadLink.href = pngUrl;
                        downloadLink.download = 'palette.png';
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            document.body.removeChild(downloadLink);
                    })
                    .catch(err => {
                        console.error('Error exporting PNG:', err);
                        alert('Error exporting palette as PNG. See console for details.');
                    })
                    .finally(() => {
                        // Re-enable button
                            exportPngButton.disabled = false;
                        exportPngButton.textContent = 'Export as PNG';
                        });
                }, 150); // Delay
            });

            // Interpolation/Saturation Listeners (No changes needed, IDs are the same)
            interpolationToggle.addEventListener('change', (event) => {
                isInterpolationEnabled = event.target.checked;
                updatePaletteView();
            });
            stepsSlider.addEventListener('input', (event) => {
                interpolationSteps = parseInt(event.target.value, 10);
                stepsNumber.value = interpolationSteps;
                if (isInterpolationEnabled) { updatePaletteView(); }
            });
            stepsNumber.addEventListener('input', (event) => {
                let value = parseInt(event.target.value, 10);
                const min = parseInt(stepsNumber.min, 10);
                const max = parseInt(stepsNumber.max, 10);
                if (isNaN(value)) { value = min; }
                else if (value < min) { value = min; }
                else if (value > max) { value = max; }
                stepsNumber.value = value;
                interpolationSteps = value;
                stepsSlider.value = interpolationSteps;
                if (isInterpolationEnabled) { updatePaletteView(); }
            });
            saturationOffsetSlider.addEventListener('input', (event) => {
                saturationOffset = parseInt(event.target.value, 10);
                saturationOffsetNumber.value = saturationOffset;
                renderPalette(currentGridData); // Just re-render
            });
            saturationOffsetNumber.addEventListener('input', (event) => {
                let value = parseInt(event.target.value, 10);
                const min = parseInt(saturationOffsetNumber.min, 10);
                const max = parseInt(saturationOffsetNumber.max, 10);
                if (isNaN(value)) { value = 0; }
                else if (value < min) { value = min; }
                else if (value > max) { value = max; }
                saturationOffsetNumber.value = value;
                saturationOffset = value;
                saturationOffsetSlider.value = saturationOffset;
                renderPalette(currentGridData); // Just re-render
            });

            // --- NEW: Zoom Control Listeners ---
            zoomSlider.addEventListener('input', (event) => {
                const zoomValue = parseInt(event.target.value, 10);
                zoomNumber.value = zoomValue; // Sync number input
                // Optional debounce
                clearTimeout(zoomTimeout);
                zoomTimeout = setTimeout(() => applyZoom(zoomValue), zoomDebounceDelay);
                // applyZoom(zoomValue); // Apply immediately without debounce
            });

            zoomNumber.addEventListener('input', (event) => {
                let value = parseInt(event.target.value, 10);
                const min = parseInt(zoomNumber.min, 10);
                const max = parseInt(zoomNumber.max, 10);
                if (isNaN(value)) {
                    value = 100; // Default to 100% if invalid
                } else if (value < min) {
                    value = min;
                } else if (value > max) {
                    value = max;
                }
                zoomNumber.value = value; // Update input field
                zoomSlider.value = value; // Sync slider
                // Optional debounce
                clearTimeout(zoomTimeout);
                zoomTimeout = setTimeout(() => applyZoom(value), zoomDebounceDelay);
                // applyZoom(value); // Apply immediately without debounce
            });

            // --- Initial Load ---
            function initializeApp() {
                // Set initial control values (if needed, should match defaults)
                stepsSlider.value = interpolationSteps;
                stepsNumber.value = interpolationSteps;
                saturationOffsetSlider.value = saturationOffset;
                saturationOffsetNumber.value = saturationOffset;
                zoomSlider.value = scale * 100; // Set initial zoom controls
                zoomNumber.value = scale * 100;

                // Set initial palette position and scale
                updateTransform();

                // Render the initial palette
                renderPalette(currentGridData);
            }

            initializeApp(); // Run initial setup

        </script>
    </body>
</html>
